name: CI Workflow - Assignment Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate-assignment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Get changed files
      run: |
        BASE_BRANCH="${{ github.base_ref }}"
        git diff --name-only origin/$BASE_BRANCH...HEAD > changed_files.txt
        
        echo "Files in this PR:"
        cat changed_files.txt
    
    - name: Check for required files
      run: |
        echo "=== Checking Required Files ==="
        
        # Check for the 3 required file types
        GB_FILE=$(grep "_gb\.txt$" changed_files.txt || echo "")
        DEVOPS_FILE=$(grep "_devops\.txt$" changed_files.txt || echo "")
        SDLC_FILE=$(grep "_sdlc\.txt$" changed_files.txt || echo "")
        
        ERRORS=0
        
        if [ -z "$GB_FILE" ]; then
          echo "❌ Missing: *_gb.txt file"
          ERRORS=$((ERRORS + 1))
        else
          echo "✅ Found: $GB_FILE"
        fi
        
        if [ -z "$DEVOPS_FILE" ]; then
          echo "❌ Missing: *_devops.txt file"
          ERRORS=$((ERRORS + 1))
        else
          echo "✅ Found: $DEVOPS_FILE"
        fi
        
        if [ -z "$SDLC_FILE" ]; then
          echo "❌ Missing: *_sdlc.txt file"
          ERRORS=$((ERRORS + 1))
        else
          echo "✅ Found: $SDLC_FILE"
        fi
        
        if [ $ERRORS -gt 0 ]; then
          echo ""
          echo "ERROR: PR must include all 3 files:"
          echo "  - *_gb.txt"
          echo "  - *_devops.txt"
          echo "  - *_sdlc.txt"
          exit 1
        fi
    
    - name: Check file content
      run: |
        echo "=== Checking File Content ==="
        
        GB_FILE=$(grep "_gb\.txt$" changed_files.txt)
        DEVOPS_FILE=$(grep "_devops\.txt$" changed_files.txt)
        SDLC_FILE=$(grep "_sdlc\.txt$" changed_files.txt)
        
        EMPTY=0
        
        for file in "$GB_FILE" "$DEVOPS_FILE" "$SDLC_FILE"; do
          if [ -f "$file" ]; then
            SIZE=$(wc -c < "$file")
            if [ $SIZE -eq 0 ]; then
              echo "❌ $file is empty"
              EMPTY=$((EMPTY + 1))
            else
              echo "✅ $file has content ($SIZE bytes)"
            fi
          fi
        done
        
        if [ $EMPTY -gt 0 ]; then
          echo ""
          echo "ERROR: All files must have content"
          exit 1
        fi
    
    - name: Check README exists
      run: |
        echo "=== Checking for README ==="
        if [ -f "README.md" ]; then
          echo "✅ README.md found"
        else
          echo "⚠️  WARNING: README.md not found"
          echo "Assignment requires updating README.md with group details"
        fi
    
    - name: Summary
      run: |
        echo ""
        echo "======================================"
        echo "       VALIDATION COMPLETE ✅"
        echo "======================================"
        echo "All required assignment files are present and valid!"
